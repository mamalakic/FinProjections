<!-- Recurring Expenses Section -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">Recurring Expenses</h3>
    </div>

    {% if recurring %}
    <div style="overflow-x: auto;">
        <table class="table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Amount</th>
                    <th>Frequency</th>
                    <th>Category</th>
                    <th>Start Date</th>
                    <th>End Date</th>
                    <th>Status</th>
                    <th>Type</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for expense in recurring %}
                <tr>
                    <td><strong>{{ expense.name }}</strong></td>
                    <td style="color: var(--danger); font-weight: 600;">{{ currency.symbol }}{{ "{:,.2f}".format(expense.amount) }}</td>
                    <td><span class="badge badge-primary">{{ expense.frequency }}</span></td>
                    <td><span class="badge badge-warning">{{ expense.category }}</span></td>
                    <td>{{ expense.start_date.strftime('%Y-%m-%d') }}</td>
                    <td>{{ expense.end_date.strftime('%Y-%m-%d') if expense.end_date else 'Ongoing' }}</td>
                    <td>
                        {% if expense.active %}
                        <span class="badge badge-success">Active</span>
                        {% else %}
                        <span class="badge badge-danger">Inactive</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if expense.get('upcoming', False) %}
                        <span class="badge" style="background: #ff9800; color: white;">Upcoming</span>
                        {% else %}
                        <span class="badge badge-success">Counted</span>
                        {% endif %}
                    </td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="editRecurringExpense('{{ expense._id }}')">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteRecurringExpense('{{ expense._id }}')">Delete</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p style="text-align: center; color: var(--text-light); padding: 2rem;">No recurring expenses added yet. Click the button above to add your first recurring expense.</p>
    {% endif %}
</div>

<!-- One-Time Expenses Section -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">One-Time Expenses</h3>
    </div>

    {% if one_time %}
    <div style="overflow-x: auto;">
        <table class="table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Amount</th>
                    <th>Date</th>
                    <th>Category</th>
                    <th>Notes</th>
                    <th>Type</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for expense in one_time %}
                <tr>
                    <td><strong>{{ expense.name }}</strong></td>
                    <td style="color: var(--danger); font-weight: 600;">{{ currency.symbol }}{{ "{:,.2f}".format(expense.amount) }}</td>
                    <td>{{ expense.date.strftime('%Y-%m-%d') }}</td>
                    <td><span class="badge badge-warning">{{ expense.category }}</span></td>
                    <td>{{ expense.notes or '-' }}</td>
                    <td>
                        {% if expense.get('upcoming', False) %}
                        <span class="badge" style="background: #ff9800; color: white;">Upcoming</span>
                        {% else %}
                        <span class="badge badge-success">Counted</span>
                        {% endif %}
                    </td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="editOneTimeExpense('{{ expense._id }}')">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteOneTimeExpense('{{ expense._id }}')">Delete</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p style="text-align: center; color: var(--text-light); padding: 2rem;">No one-time expenses recorded yet. Click the button above to add groceries, shopping, or other one-time expenses.</p>
    {% endif %}
</div>

<!-- Recurring Expense Modal -->
<div id="recurringModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="recurringModalTitle">Add Recurring Expense</h3>
            <button class="close-btn" onclick="closeModal('recurringModal')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="recurringForm" onsubmit="saveRecurringExpense(event)">
                <input type="hidden" id="recurringId">
                
                <div class="form-group">
                    <label class="form-label">Name *</label>
                    <input type="text" class="form-control" id="recurringName" required placeholder="e.g., Rent">
                </div>

                <div class="form-group">
                    <label class="form-label">Amount ({{ currency.symbol }}) *</label>
                    <input type="number" step="0.01" class="form-control" id="recurringAmount" required placeholder="0.00">
                </div>

                <div class="form-group">
                    <label class="form-label">Frequency *</label>
                    <select class="form-control" id="recurringFrequency" required>
                        <option value="monthly">Monthly</option>
                        <option value="weekly">Weekly</option>
                        <option value="biweekly">Bi-weekly</option>
                        <option value="yearly">Yearly</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Category *</label>
                    <select class="form-control" id="recurringCategory" required>
                        <option value="rent">Rent/Mortgage</option>
                        <option value="utilities">Utilities</option>
                        <option value="insurance">Insurance</option>
                        <option value="subscriptions">Subscriptions</option>
                        <option value="loan">Loan Payment</option>
                        <option value="transportation">Transportation</option>
                        <option value="food">Food/Dining</option>
                        <option value="healthcare">Healthcare</option>
                        <option value="entertainment">Entertainment</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Start Date *</label>
                    <input type="date" class="form-control" id="recurringStartDate" required>
                </div>

                <div class="form-group">
                    <label class="form-label">End Date (Optional)</label>
                    <input type="date" class="form-control" id="recurringEndDate">
                    <small style="color: var(--text-light);">Leave empty for ongoing expense</small>
                </div>

                <div class="form-group">
                    <label class="form-label">Due Date (Day of Month, Optional)</label>
                    <input type="number" min="1" max="31" class="form-control" id="recurringPayday" placeholder="e.g., 5 for 5th of month">
                    <small style="color: var(--text-light);">When this bill is due each month</small>
                </div>

                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                        <input type="checkbox" id="recurringActive" checked>
                        <span class="form-label" style="margin: 0;">Active</span>
                    </label>
                </div>

                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                        <input type="checkbox" id="recurringUpcoming">
                        <span class="form-label" style="margin: 0;">Upcoming (visible but not counted in projections)</span>
                    </label>
                </div>

                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" class="btn" onclick="closeModal('recurringModal')" style="background: var(--border);">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- One-Time Expense Modal -->
<div id="oneTimeModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="oneTimeModalTitle">Add One-Time Expense</h3>
            <button class="close-btn" onclick="closeModal('oneTimeModal')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="oneTimeForm" onsubmit="saveOneTimeExpense(event)">
                <input type="hidden" id="oneTimeId">
                
                <div class="form-group">
                    <label class="form-label">Name *</label>
                    <input type="text" class="form-control" id="oneTimeName" required placeholder="e.g., Grocery Shopping">
                </div>

                <div class="form-group">
                    <label class="form-label">Amount ({{ currency.symbol }}) *</label>
                    <input type="number" step="0.01" class="form-control" id="oneTimeAmount" required placeholder="0.00">
                </div>

                <div class="form-group">
                    <label class="form-label">Date *</label>
                    <input type="date" class="form-control" id="oneTimeDate" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Category *</label>
                    <select class="form-control" id="oneTimeCategory" required>
                        <option value="groceries">Groceries</option>
                        <option value="shopping">Shopping</option>
                        <option value="dining">Dining Out</option>
                        <option value="entertainment">Entertainment</option>
                        <option value="healthcare">Healthcare</option>
                        <option value="transportation">Transportation</option>
                        <option value="bills">Bills</option>
                        <option value="gifts">Gifts</option>
                        <option value="home">Home Improvement</option>
                        <option value="education">Education</option>
                        <option value="travel">Travel</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea class="form-control" id="oneTimeNotes" rows="3" placeholder="Optional notes..."></textarea>
                </div>

                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                        <input type="checkbox" id="oneTimeUpcoming">
                        <span class="form-label" style="margin: 0;">Upcoming (visible but not counted in projections)</span>
                    </label>
                </div>

                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" class="btn" onclick="closeModal('oneTimeModal')" style="background: var(--border);">Cancel</button>
                    <button type="submit" class="btn btn-success">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Initialize function
    function initializeExpensesPage() {
        // Set default date to today
        const recurringStartDate = document.getElementById('recurringStartDate');
        const oneTimeDate = document.getElementById('oneTimeDate');
        
        if (recurringStartDate) recurringStartDate.valueAsDate = new Date();
        if (oneTimeDate) oneTimeDate.valueAsDate = new Date();
    }

    // Run initialization for full page loads (HTMX will call it via afterSwap event)
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeExpensesPage);
    } else if (!window.htmxSwapping) {
        setTimeout(initializeExpensesPage, 0);
    }

    // Recurring Expense Functions
    function openAddRecurringModal() {
        document.getElementById('recurringModalTitle').textContent = 'Add Recurring Expense';
        document.getElementById('recurringForm').reset();
        document.getElementById('recurringId').value = '';
        document.getElementById('recurringStartDate').valueAsDate = new Date();
        document.getElementById('recurringActive').checked = true;
        document.getElementById('recurringUpcoming').checked = false;
        openModal('recurringModal');
    }

    function editRecurringExpense(id) {
        fetch(`/api/recurring-expense/${id}`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('recurringModalTitle').textContent = 'Edit Recurring Expense';
                document.getElementById('recurringId').value = data.id;
                document.getElementById('recurringName').value = data.name;
                document.getElementById('recurringAmount').value = data.amount;
                document.getElementById('recurringFrequency').value = data.frequency;
                document.getElementById('recurringCategory').value = data.category;
                document.getElementById('recurringStartDate').value = data.start_date.split('T')[0];
                document.getElementById('recurringEndDate').value = data.end_date ? data.end_date.split('T')[0] : '';
                document.getElementById('recurringPayday').value = data.payday || '';
                document.getElementById('recurringActive').checked = data.active;
                document.getElementById('recurringUpcoming').checked = data.upcoming || false;
                openModal('recurringModal');
            });
    }

    function saveRecurringExpense(event) {
        event.preventDefault();
        
        const id = document.getElementById('recurringId').value;
        const paydayValue = document.getElementById('recurringPayday').value;
        const data = {
            name: document.getElementById('recurringName').value,
            amount: document.getElementById('recurringAmount').value,
            frequency: document.getElementById('recurringFrequency').value,
            category: document.getElementById('recurringCategory').value,
            start_date: document.getElementById('recurringStartDate').value,
            end_date: document.getElementById('recurringEndDate').value || null,
            payday: paydayValue ? parseInt(paydayValue) : null,
            active: document.getElementById('recurringActive').checked,
            upcoming: document.getElementById('recurringUpcoming').checked
        };

        const url = id ? `/api/recurring-expense/${id}` : '/api/recurring-expense';
        const method = id ? 'PUT' : 'POST';

        fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                showAlert(id ? 'Recurring expense updated!' : 'Recurring expense added!', 'success');
                closeModal('recurringModal');
                setTimeout(() => location.reload(), 1000);
            }
        })
        .catch(error => {
            showAlert('Error saving recurring expense', 'error');
            console.error(error);
        });
    }

    function deleteRecurringExpense(id) {
        if (!confirm('Are you sure you want to delete this recurring expense?')) return;

        fetch(`/api/recurring-expense/${id}`, { method: 'DELETE' })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showAlert('Recurring expense deleted!', 'success');
                    setTimeout(() => location.reload(), 1000);
                }
            })
            .catch(error => {
                showAlert('Error deleting recurring expense', 'error');
                console.error(error);
            });
    }

    // One-Time Expense Functions
    function openAddOneTimeModal() {
        document.getElementById('oneTimeModalTitle').textContent = 'Add One-Time Expense';
        document.getElementById('oneTimeForm').reset();
        document.getElementById('oneTimeId').value = '';
        document.getElementById('oneTimeDate').valueAsDate = new Date();
        document.getElementById('oneTimeUpcoming').checked = false;
        openModal('oneTimeModal');
    }

    function editOneTimeExpense(id) {
        fetch(`/api/one-time-expense/${id}`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('oneTimeModalTitle').textContent = 'Edit One-Time Expense';
                document.getElementById('oneTimeId').value = data.id;
                document.getElementById('oneTimeName').value = data.name;
                document.getElementById('oneTimeAmount').value = data.amount;
                document.getElementById('oneTimeDate').value = data.date.split('T')[0];
                document.getElementById('oneTimeCategory').value = data.category;
                document.getElementById('oneTimeNotes').value = data.notes || '';
                document.getElementById('oneTimeUpcoming').checked = data.upcoming || false;
                openModal('oneTimeModal');
            });
    }

    function saveOneTimeExpense(event) {
        event.preventDefault();
        
        const id = document.getElementById('oneTimeId').value;
        const data = {
            name: document.getElementById('oneTimeName').value,
            amount: document.getElementById('oneTimeAmount').value,
            date: document.getElementById('oneTimeDate').value,
            category: document.getElementById('oneTimeCategory').value,
            notes: document.getElementById('oneTimeNotes').value,
            upcoming: document.getElementById('oneTimeUpcoming').checked
        };

        const url = id ? `/api/one-time-expense/${id}` : '/api/one-time-expense';
        const method = id ? 'PUT' : 'POST';

        fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                showAlert(id ? 'One-time expense updated!' : 'One-time expense added!', 'success');
                closeModal('oneTimeModal');
                setTimeout(() => location.reload(), 1000);
            }
        })
        .catch(error => {
            showAlert('Error saving one-time expense', 'error');
            console.error(error);
        });
    }

    function deleteOneTimeExpense(id) {
        if (!confirm('Are you sure you want to delete this one-time expense?')) return;

        fetch(`/api/one-time-expense/${id}`, { method: 'DELETE' })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showAlert('One-time expense deleted!', 'success');
                    setTimeout(() => location.reload(), 1000);
                }
            })
            .catch(error => {
                showAlert('Error deleting one-time expense', 'error');
                console.error(error);
            });
    }
</script>