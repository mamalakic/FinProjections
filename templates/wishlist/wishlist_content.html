<!-- Financial Summary Cards -->
<div class="grid" id="wishlistSummary">
    <div class="stat-card" title="Your current projected cumulative balance">
        <div class="stat-label">Current Balance <i class="ri-information-line" style="font-size: 0.9em; opacity: 0.7;"></i></div>
        <div class="stat-value" id="currentBalance">$0.00</div>
    </div>
    <div class="stat-card success" title="Average amount you save per month">
        <div class="stat-label">Avg Monthly Savings <i class="ri-information-line" style="font-size: 0.9em; opacity: 0.7;"></i></div>
        <div class="stat-value" id="avgMonthlySavings">$0.00</div>
    </div>
    <div class="stat-card danger" title="Total cost of all items in your wishlist">
        <div class="stat-label">Total Wishlist Cost <i class="ri-information-line" style="font-size: 0.9em; opacity: 0.7;"></i></div>
        <div class="stat-value" id="totalWishlistCost">$0.00</div>
    </div>
    <div class="stat-card" title="What percentage of your balance the wishlist represents">
        <div class="stat-label">Wishlist as % of Balance <i class="ri-information-line" style="font-size: 0.9em; opacity: 0.7;"></i></div>
        <div class="stat-value" id="wishlistPercentage">0%</div>
    </div>
</div>

<!-- Filter and Sort Controls -->
<div class="card" style="margin-bottom: 1.5rem;">
    <div class="card-body" style="padding: 1rem;">
        <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 200px;">
                <label style="display: block; margin-bottom: 0.25rem; font-size: 0.875rem; font-weight: 500;">Filter by Priority</label>
                <select id="priorityFilter" onchange="filterWishlist()" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: 6px;">
                    <option value="all">All Priorities</option>
                    <option value="high">High Priority</option>
                    <option value="medium">Medium Priority</option>
                    <option value="low">Low Priority</option>
                </select>
            </div>
            <div style="flex: 1; min-width: 200px;">
                <label style="display: block; margin-bottom: 0.25rem; font-size: 0.875rem; font-weight: 500;">Filter by Category</label>
                <select id="categoryFilter" onchange="filterWishlist()" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: 6px;">
                    <option value="all">All Categories</option>
                    <!-- Categories loaded dynamically -->
                </select>
            </div>
            <div style="flex: 1; min-width: 200px;">
                <label style="display: block; margin-bottom: 0.25rem; font-size: 0.875rem; font-weight: 500;">Sort By</label>
                <select id="sortBy" onchange="sortWishlist()" style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: 6px;">
                    <option value="priority">Priority</option>
                    <option value="cost-asc">Cost (Low to High)</option>
                    <option value="cost-desc">Cost (High to Low)</option>
                    <option value="affordable">Affordability</option>
                    <option value="target-date">Target Date</option>
                </select>
            </div>
            <div style="display: flex; align-items: flex-end; gap: 0.5rem;">
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem;">
                    <input type="checkbox" id="showPurchased" onchange="filterWishlist()" style="width: 18px; height: 18px;">
                    <span style="font-size: 0.875rem;">Show Purchased</span>
                </label>
            </div>
        </div>
    </div>
</div>

<!-- Wishlist Items with Financial Analysis -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">Your Wishlist Items</h3>
        <div style="font-size: 0.875rem; color: var(--text-light); margin-top: 0.5rem;">
            <span id="affordableCount">0</span> of <span id="totalCount">0</span> items affordable now
        </div>
    </div>

    <div id="wishlistContainer">
        <p style="text-align: center; color: var(--text-light); padding: 2rem;">Loading wishlist analysis...</p>
    </div>
</div>

<!-- Add Custom Category Modal -->
<div id="categoryModal" class="modal" style="z-index: 1001;">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
            <h3 class="modal-title">Add Custom Category</h3>
            <button class="close-btn" onclick="closeModal('categoryModal')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="categoryForm" onsubmit="saveCustomCategory(event)">
                <div class="form-group">
                    <label for="categoryName">Category Name *</label>
                    <input type="text" id="categoryName" required placeholder="e.g., Home Improvement, Hobbies">
                </div>

                <div class="form-group">
                    <label for="categoryIcon">Icon (optional)</label>
                    <select id="categoryIcon">
                        <option value="ri-bookmark-line">Default (Bookmark)</option>
                        <option value="ri-home-line">Home</option>
                        <option value="ri-tools-line">Tools</option>
                        <option value="ri-palette-line">Art/Hobbies</option>
                        <option value="ri-shirt-line">Clothing</option>
                        <option value="ri-restaurant-line">Food/Dining</option>
                        <option value="ri-gift-line">Gifts</option>
                        <option value="ri-plant-line">Garden</option>
                        <option value="ri-gamepad-line">Gaming</option>
                        <option value="ri-music-line">Music</option>
                        <option value="ri-camera-line">Photography</option>
                        <option value="ri-bike-line">Sports</option>
                        <option value="ri-shopping-bag-line">Shopping</option>
                        <option value="ri-briefcase-line">Business</option>
                        <option value="ri-star-line">Premium</option>
                    </select>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('categoryModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Category</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add/Edit Wishlist Item Modal -->
<div id="wishlistModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="modalTitle">Add Wishlist Item</h3>
            <button class="close-btn" onclick="closeModal('wishlistModal')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="wishlistForm" onsubmit="saveWishlistItem(event)">
                <input type="hidden" id="itemId">
                
                <div class="form-group">
                    <label for="itemName">Item Name *</label>
                    <input type="text" id="itemName" required placeholder="e.g., New Laptop, Vacation to Japan">
                </div>

                <div class="form-group">
                    <label for="itemCost">Cost * <span style="font-size: 0.875rem; color: var(--text-light);">({{ currency.symbol }})</span></label>
                    <input type="number" id="itemCost" step="0.01" min="0" required placeholder="0.00">
                </div>

                <div class="form-group">
                    <label for="itemCategory">Category *</label>
                    <div style="display: flex; gap: 0.5rem;">
                        <select id="itemCategory" required style="flex: 1;">
                            <option value="">Select a category</option>
                            <!-- Categories loaded dynamically -->
                        </select>
                        <button type="button" class="btn btn-secondary" onclick="openAddCategoryModal()" title="Add custom category" style="padding: 0.5rem 0.75rem;">
                            <i class="ri-add-line"></i>
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="itemPriority">Priority *</label>
                    <select id="itemPriority" required>
                        <option value="high">High - Need it soon</option>
                        <option value="medium" selected>Medium - Would be nice</option>
                        <option value="low">Low - Can wait</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="itemTargetDate">Target Date <span style="font-size: 0.875rem; color: var(--text-light);">(Optional - when do you want to buy this?)</span></label>
                    <input type="date" id="itemTargetDate">
                </div>

                <div class="form-group">
                    <label for="itemUrl">URL <span style="font-size: 0.875rem; color: var(--text-light);">(Optional - link to product page)</span></label>
                    <input type="url" id="itemUrl" placeholder="https://...">
                </div>

                <div class="form-group">
                    <label for="itemNotes">Notes <span style="font-size: 0.875rem; color: var(--text-light);">(Optional)</span></label>
                    <textarea id="itemNotes" rows="3" placeholder="Any additional details..."></textarea>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('wishlistModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Item</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    let wishlistAnalysis = null;
    let allItems = [];
    let allCategories = [];

    // Initialize wishlist on page load
    function initializeWishlist() {
        loadCategories();
        loadWishlistAnalysis();
    }

    // Load categories
    function loadCategories() {
        fetch('/api/wishlist-categories')
            .then(response => response.json())
            .then(data => {
                allCategories = data.categories;
                populateCategorySelects();
            })
            .catch(error => {
                console.error('Error loading categories:', error);
            });
    }

    function populateCategorySelects() {
        // Populate filter dropdown
        const filterSelect = document.getElementById('categoryFilter');
        const currentFilterValue = filterSelect.value;
        filterSelect.innerHTML = '<option value="all">All Categories</option>';
        allCategories.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat.name;
            option.textContent = cat.name;
            filterSelect.appendChild(option);
        });
        filterSelect.value = currentFilterValue;

        // Populate form dropdown
        const formSelect = document.getElementById('itemCategory');
        const currentFormValue = formSelect.value;
        formSelect.innerHTML = '<option value="">Select a category</option>';
        allCategories.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat.name;
            option.textContent = cat.name + (cat.is_custom ? ' (Custom)' : '');
            formSelect.appendChild(option);
        });
        formSelect.value = currentFormValue;
    }

    // Load wishlist with financial analysis
    function loadWishlistAnalysis() {
        fetch('/api/wishlist-analysis')
            .then(response => response.json())
            .then(data => {
                wishlistAnalysis = data;
                allItems = data.items;
                updateSummary(data.summary);
                renderWishlist(data.items);
            })
            .catch(error => {
                console.error('Error loading wishlist:', error);
                document.getElementById('wishlistContainer').innerHTML = 
                    '<p style="text-align: center; color: var(--danger); padding: 2rem;">Error loading wishlist. Please try again.</p>';
            });
    }

    function updateSummary(summary) {
        document.getElementById('currentBalance').textContent = formatCurrency(summary.current_balance);
        document.getElementById('avgMonthlySavings').textContent = formatCurrency(summary.avg_monthly_savings);
        document.getElementById('totalWishlistCost').textContent = formatCurrency(summary.total_wishlist_cost);
        document.getElementById('wishlistPercentage').textContent = summary.total_as_percentage + '%';
        document.getElementById('affordableCount').textContent = summary.affordable_now;
        document.getElementById('totalCount').textContent = summary.total_items;
    }

    function getPriceGradientColor(percentage) {
        // 0-5%: Light green
        // 5-20%: Green to yellow-green
        // 20-50%: Yellow to orange
        // 50-100%: Orange to dark orange
        // 100-200%: Red to deep red
        // 200+%: Deep red
        
        if (percentage <= 5) {
            return '#10b981'; // Light green
        } else if (percentage <= 20) {
            const ratio = (percentage - 5) / 15;
            return interpolateColor('#10b981', '#84cc16', ratio); // Green to lime
        } else if (percentage <= 50) {
            const ratio = (percentage - 20) / 30;
            return interpolateColor('#84cc16', '#f59e0b', ratio); // Lime to orange
        } else if (percentage <= 100) {
            const ratio = (percentage - 50) / 50;
            return interpolateColor('#f59e0b', '#ea580c', ratio); // Orange to dark orange
        } else if (percentage <= 200) {
            const ratio = (percentage - 100) / 100;
            return interpolateColor('#ea580c', '#dc2626', ratio); // Dark orange to red
        } else {
            return '#991b1b'; // Deep red
        }
    }
    
    function interpolateColor(color1, color2, ratio) {
        const hex = (color) => {
            const c = color.substring(1);
            return parseInt(c, 16);
        };
        
        const r1 = (hex(color1) >> 16) & 255;
        const g1 = (hex(color1) >> 8) & 255;
        const b1 = hex(color1) & 255;
        
        const r2 = (hex(color2) >> 16) & 255;
        const g2 = (hex(color2) >> 8) & 255;
        const b2 = hex(color2) & 255;
        
        const r = Math.round(r1 + (r2 - r1) * ratio);
        const g = Math.round(g1 + (g2 - g1) * ratio);
        const b = Math.round(b1 + (b2 - b1) * ratio);
        
        return `#${((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1)}`;
    }

    function renderWishlist(items) {
        const container = document.getElementById('wishlistContainer');
        
        if (items.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: var(--text-light); padding: 2rem;">No wishlist items yet. Click "Add Wishlist Item" to get started!</p>';
            return;
        }

        // Group items by category
        const categories = {};
        items.forEach(item => {
            if (!categories[item.category]) {
                categories[item.category] = [];
            }
            categories[item.category].push(item);
        });

        // Category icons - build dynamically from loaded categories
        const categoryIcons = {};
        allCategories.forEach(cat => {
            categoryIcons[cat.name] = cat.icon;
        });

        let html = '<div style="padding: 1rem;">';
        
        // Render each category
        Object.keys(categories).sort().forEach(category => {
            const categoryItems = categories[category];
            const icon = categoryIcons[category] || 'ri-more-line';
            
            html += `
                <div style="margin-bottom: 2rem;">
                    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid var(--border);">
                        <i class="${icon}" style="font-size: 1.5rem; color: var(--primary);"></i>
                        <h3 style="margin: 0; font-size: 1.125rem; color: var(--text); font-weight: 600;">${category}</h3>
                        <span style="color: var(--text-light); font-size: 0.875rem;">(${categoryItems.length})</span>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 0.75rem; padding-left: 2rem; border-left: 3px solid var(--border);">
            `;
            
            categoryItems.forEach((item, index) => {
                const priorityColors = {
                    'high': '#ef4444',
                    'medium': '#f59e0b',
                    'low': '#6b7280'
                };
                const priorityColor = priorityColors[item.priority] || priorityColors['medium'];
                
                // Calculate price color based on balance percentage
                const priceColor = getPriceGradientColor(item.balance_percentage);
                
                // Determine affordability status (no badge, just text)
                let affordabilityText = '';
                let timelineText = '';
                
                if (item.can_afford_now) {
                    affordabilityText = `<span style="color: var(--success); font-size: 0.8rem;">
                        <i class="ri-checkbox-circle-line"></i> Affordable now - balance after: ${formatCurrency(item.balance_after_purchase)}
                    </span>`;
                } else if (item.months_until_affordable > 0) {
                    if (item.affordable_by_month) {
                        timelineText = `<span style="color: var(--warning); font-size: 0.8rem;">
                            <i class="ri-time-line"></i> ${item.affordable_by_month}
                        </span>`;
                    } else {
                        timelineText = `<span style="color: var(--warning); font-size: 0.8rem;">
                            <i class="ri-time-line"></i> ~${item.months_until_affordable}mo
                        </span>`;
                    }
                }
                
                // Compact target date
                let targetDateInfo = '';
                if (item.target_date && item.required_monthly_savings) {
                    const targetDate = new Date(item.target_date);
                    const formattedDate = targetDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                    targetDateInfo = `<span style="color: var(--primary); font-size: 0.8rem;">
                        <i class="ri-calendar-line"></i> ${formattedDate}
                    </span>`;
                }
                
                html += `
                    <div class="wishlist-item" data-priority="${item.priority}" data-category="${item.category}" data-cost="${item.cost}" data-affordable="${item.can_afford_now}" data-target-date="${item.target_date || ''}" 
                         style="background: white; border-radius: 8px; padding: 0.875rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-left: 3px solid ${priorityColor}; position: relative;">
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; gap: 1rem;">
                            <div style="flex: 1; min-width: 0;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                                    <h4 style="margin: 0; font-size: 1rem; color: var(--text); font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${item.name}</h4>
                                    ${item.url ? `<a href="${item.url}" target="_blank" style="color: var(--primary); font-size: 0.875rem; flex-shrink: 0;" title="View Product">
                                        <i class="ri-external-link-line"></i>
                                    </a>` : ''}
                                </div>
                                <div style="display: flex; gap: 0.75rem; flex-wrap: wrap; align-items: center; font-size: 0.8rem;">
                                    <span class="badge" style="background: ${priorityColor}; color: white; padding: 0.125rem 0.5rem; font-size: 0.75rem;">${item.priority.toUpperCase()}</span>
                                    ${affordabilityText}
                                    ${timelineText}
                                    ${targetDateInfo}
                                    ${item.notes ? `<span style="color: var(--text-light);" title="${item.notes}">
                                        <i class="ri-sticky-note-line"></i>
                                    </span>` : ''}
                                </div>
                            </div>
                            
                            <div style="text-align: right; flex-shrink: 0;">
                                <div style="font-size: 1.25rem; font-weight: 700; color: ${priceColor}; font-family: var(--font-mono);">
                                    ${formatCurrency(item.cost)}
                                </div>
                                <div style="font-size: 0.75rem; color: var(--text-light);">
                                    ${item.balance_percentage}%
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 0.25rem; flex-shrink: 0;">
                                <button class="btn btn-sm" onclick="editWishlistItem('${item.id}')" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" title="Edit">
                                    <i class="ri-edit-line"></i>
                                </button>
                                <button class="btn btn-sm btn-success" onclick="togglePurchased('${item.id}')" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" title="Mark as Purchased">
                                    <i class="ri-shopping-bag-line"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteWishlistItem('${item.id}')" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" title="Delete">
                                    <i class="ri-delete-bin-line"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        container.innerHTML = html;
    }

    function filterWishlist() {
        const priorityFilter = document.getElementById('priorityFilter').value;
        const categoryFilter = document.getElementById('categoryFilter').value;
        const showPurchased = document.getElementById('showPurchased').checked;
        
        let filtered = allItems.filter(item => {
            if (!showPurchased && item.purchased) return false;
            if (priorityFilter !== 'all' && item.priority !== priorityFilter) return false;
            if (categoryFilter !== 'all' && item.category !== categoryFilter) return false;
            return true;
        });
        
        renderWishlist(filtered);
    }

    function sortWishlist() {
        const sortBy = document.getElementById('sortBy').value;
        
        let sorted = [...allItems];
        
        // Always sort by category first, then by the selected criteria within each category
        switch(sortBy) {
            case 'priority':
                const priorityOrder = { 'high': 1, 'medium': 2, 'low': 3 };
                sorted.sort((a, b) => {
                    if (a.category !== b.category) return a.category.localeCompare(b.category);
                    return priorityOrder[a.priority] - priorityOrder[b.priority];
                });
                break;
            case 'cost-asc':
                sorted.sort((a, b) => {
                    if (a.category !== b.category) return a.category.localeCompare(b.category);
                    return a.cost - b.cost;
                });
                break;
            case 'cost-desc':
                sorted.sort((a, b) => {
                    if (a.category !== b.category) return a.category.localeCompare(b.category);
                    return b.cost - a.cost;
                });
                break;
            case 'affordable':
                sorted.sort((a, b) => {
                    if (a.category !== b.category) return a.category.localeCompare(b.category);
                    if (a.can_afford_now && !b.can_afford_now) return -1;
                    if (!a.can_afford_now && b.can_afford_now) return 1;
                    return a.months_until_affordable - b.months_until_affordable;
                });
                break;
            case 'target-date':
                sorted.sort((a, b) => {
                    if (a.category !== b.category) return a.category.localeCompare(b.category);
                    if (!a.target_date) return 1;
                    if (!b.target_date) return -1;
                    return new Date(a.target_date) - new Date(b.target_date);
                });
                break;
        }
        
        allItems = sorted;
        filterWishlist();
    }

    function refreshAnalysis() {
        showAlert('Refreshing analysis...', 'info');
        loadWishlistAnalysis();
    }

    function openAddModal() {
        document.getElementById('modalTitle').textContent = 'Add Wishlist Item';
        document.getElementById('wishlistForm').reset();
        document.getElementById('itemId').value = '';
        openModal('wishlistModal');
    }

    function editWishlistItem(id) {
        fetch(`/api/wishlist/${id}`)
            .then(response => response.json())
            .then(item => {
                document.getElementById('modalTitle').textContent = 'Edit Wishlist Item';
                document.getElementById('itemId').value = item.id;
                document.getElementById('itemName').value = item.name;
                document.getElementById('itemCost').value = item.cost;
                document.getElementById('itemCategory').value = item.category;
                document.getElementById('itemPriority').value = item.priority;
                document.getElementById('itemTargetDate').value = item.target_date || '';
                document.getElementById('itemUrl').value = item.url || '';
                document.getElementById('itemNotes').value = item.notes || '';
                openModal('wishlistModal');
            })
            .catch(error => {
                console.error('Error loading item:', error);
                showAlert('Error loading item', 'error');
            });
    }

    function saveWishlistItem(event) {
        event.preventDefault();
        
        const id = document.getElementById('itemId').value;
        const data = {
            name: document.getElementById('itemName').value,
            cost: parseFloat(document.getElementById('itemCost').value),
            category: document.getElementById('itemCategory').value,
            priority: document.getElementById('itemPriority').value,
            target_date: document.getElementById('itemTargetDate').value || null,
            url: document.getElementById('itemUrl').value,
            notes: document.getElementById('itemNotes').value
        };
        
        const url = id ? `/api/wishlist/${id}` : '/api/wishlist';
        const method = id ? 'PUT' : 'POST';
        
        fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                showAlert(id ? 'Item updated successfully' : 'Item added successfully', 'success');
                closeModal('wishlistModal');
                loadWishlistAnalysis();
            }
        })
        .catch(error => {
            console.error('Error saving item:', error);
            showAlert('Error saving item', 'error');
        });
    }

    function togglePurchased(id) {
        if (!confirm('Mark this item as purchased?')) return;
        
        fetch(`/api/wishlist/${id}/toggle-purchased`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                showAlert('Item marked as purchased!', 'success');
                loadWishlistAnalysis();
            }
        })
        .catch(error => {
            console.error('Error updating item:', error);
            showAlert('Error updating item', 'error');
        });
    }

    function deleteWishlistItem(id) {
        if (!confirm('Are you sure you want to delete this wishlist item?')) return;
        
        fetch(`/api/wishlist/${id}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                showAlert('Item deleted successfully', 'success');
                loadWishlistAnalysis();
            }
        })
        .catch(error => {
            console.error('Error deleting item:', error);
            showAlert('Error deleting item', 'error');
        });
    }

    function openAddCategoryModal() {
        document.getElementById('categoryForm').reset();
        openModal('categoryModal');
    }

    function saveCustomCategory(event) {
        event.preventDefault();
        
        const data = {
            name: document.getElementById('categoryName').value,
            icon: document.getElementById('categoryIcon').value
        };
        
        fetch('/api/wishlist-categories', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => { throw new Error(err.error); });
            }
            return response.json();
        })
        .then(result => {
            if (result.success) {
                showAlert('Category added successfully', 'success');
                closeModal('categoryModal');
                loadCategories();
            }
        })
        .catch(error => {
            console.error('Error saving category:', error);
            showAlert(error.message || 'Error saving category', 'error');
        });
    }

    // Initialize on page load
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeWishlist);
    } else if (!window.htmxSwapping) {
        setTimeout(initializeWishlist, 0);
    }
</script>

